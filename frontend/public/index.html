<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Campus Clubs & Events — Phase 2 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{color-scheme:light dark;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{margin:24px;max-width:1100px}
    section{border:1px solid #d0d7de;border-radius:12px;padding:18px;margin-bottom:18px;background:rgba(255,255,255,0.9)}
    label{display:block;margin-top:8px;font-weight:600}
    input,select,textarea{width:100%;max-width:420px;padding:8px;margin-top:4px;font:inherit}
    textarea{min-height:80px}
    button{margin-top:10px;padding:8px 12px;font:inherit;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eaecef;padding:8px;text-align:left;font-size:0.95rem}
    .row{display:flex;flex-wrap:wrap;gap:18px}
    .row>div{flex:1 1 320px}
    pre{background:#0b1020;color:#e6edf3;padding:12px;border-radius:10px;overflow:auto;max-height:200px}
    small{display:block;color:#57606a;margin-top:4px}
    .highlight{background:#fff3cd;transition:background 0.4s ease}
    .clickable-row{cursor:pointer}
  </style>
</head>
<body>
  <h1>Campus Clubs & Events</h1>

  <section>
    <h2>Persona headers</h2>
    <div class="row">
      <div>
        <label>Email <input id="persona_email" value="student@example.edu"></label>
        <label>Role
          <select id="persona_role">
            <option value="student">student</option>
            <option value="leader">leader</option>
            <option value="admin">admin</option>
          </select>
        </label>
        <small>These map to <code>X-User-Email</code> and <code>X-User-Role</code> headers.</small>
      </div>
      <div>
        <label>Club Leader Quick-fill
          <button type="button" onclick="setPersona('leader@school.edu','leader')">AI Club Leader</button>
        </label>
        <label>Admin Quick-fill
          <button type="button" onclick="setPersona('admin@school.edu','admin')">Admin</button>
        </label>
      </div>
    </div>
  </section>

  <section>
    <h2>Discover events</h2>
    <div class="row">
      <div>
        <label>Starts after <input id="filter_start" placeholder="2024-09-01T00:00:00Z"></label>
        <label>Ends before <input id="filter_end" placeholder="2024-09-30T23:59:59Z"></label>
        <label>Category <input id="filter_category" placeholder="tech"></label>
        <label>Location contains <input id="filter_location" placeholder="ENG"></label>
        <label>Sort
          <select id="filter_sort">
            <option value="date">date</option>
            <option value="popularity">popularity</option>
          </select>
        </label>
        <label><input type="checkbox" id="filter_free"> Free only</label>
        <button onclick="listEvents()">Run search</button>
        <button onclick="loadTrending()">Trending</button>
      </div>
      <div>
        <h3>Create event</h3>
        <label>Title <input id="event_title" value="Hack Night"></label>
        <label>Starts At <input id="event_starts"></label>
        <label>Location <input id="event_location" value="Student Union"></label>
        <label>Capacity <input type="number" id="event_capacity" value="5"></label>
        <label>Price (cents) <input type="number" id="event_price" value="0"></label>
        <label>Category <input id="event_category" value="tech"></label>
        <label>Club ID (optional) <input type="number" id="event_club"></label>
        <button onclick="createEvent()">Create</button>
      </div>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Title</th><th>When</th><th>Location</th><th>Category</th><th>Club</th><th>Capacity</th><th>Registered</th><th></th></tr>
      </thead>
      <tbody id="events_tbody"></tbody>
    </table>
    <h3>Trending</h3>
    <ul id="trending_list"></ul>
  </section>

  <section>
    <h2>My Events</h2>
    <p>See the events this persona is registered for and jump to them in the main list.</p>
    <button onclick="loadMyEvents()">Load my registered events</button>
    <table>
      <thead>
        <tr><th>Title</th><th>When</th><th>Location</th><th>Category</th></tr>
      </thead>
      <tbody id="my_events_tbody"><tr><td colspan="4">Click the button above to load your registrations.</td></tr></tbody>
    </table>
  </section>

  <section>
    <h2>Clubs directory</h2>
    <div class="row">
      <div>
        <p>Join or leave clubs directly from the list using the buttons below.</p>
        <button onclick="loadClubs()">Refresh clubs</button>
        <ul id="club_list"></ul>
      </div>
      <div>
        <h3>Create a club</h3>
        <label>Name <input id="club_name" placeholder="Board Games"></label>
        <label>Description <textarea id="club_desc" placeholder="What does this club do?"></textarea></label>
        <button onclick="createClub()">Submit club (pending approval)</button>
        <pre id="club_create_result"></pre>
        <h3>Join a club</h3>
        <label>Club ID <input type="number" id="join_club_id"></label>
        <button onclick="joinClub()">Request to join</button>
        <pre id="club_join_result"></pre>
      </div>
    </div>
    <div>
      <h3>My Clubs</h3>
      <p>Shows clubs where this persona has an approved membership.</p>
      <button onclick="loadMyClubs()">Load my clubs</button>
      <ul id="my_club_list"><li>Use the persona headers above, then click the button to load.</li></ul>
    </div>
  </section>

  <section>
    <h2>Club page</h2>
    <label>Club ID <input type="number" id="club_detail_id" value="1"></label>
    <button onclick="loadClubDetail()">Load club</button>
    <div id="club_detail"></div>

    <div class="row">
      <div>
        <h3>Leader tools</h3>
        <label>Approve member email <input id="approve_email" placeholder="student@example.edu"></label>
        <button onclick="approveMember()">Approve</button>
        <h4>Post announcement</h4>
        <label>Title <input id="ann_title"></label>
        <label>Body <textarea id="ann_body"></textarea></label>
        <button onclick="postAnnouncement()">Publish</button>
      </div>
      <div>
        <h3>Schedule club event</h3>
        <label>Title <input id="club_event_title" value="Study Session"></label>
        <label>Starts At <input id="club_event_starts"></label>
        <label>Location <input id="club_event_location" value="Library 201"></label>
        <label>Capacity <input type="number" id="club_event_capacity" value="10"></label>
        <label>Price (cents) <input type="number" id="club_event_price" value="0"></label>
        <label>Category <input id="club_event_category" value="community"></label>
        <button onclick="createClubEvent()">Create</button>
      </div>
    </div>
  </section>

  <section>
    <h2>Admin dashboard</h2>
    <button onclick="loadPendingClubs()">Load pending clubs</button>
    <ul id="pending_club_list"></ul>
    <label>Approve club ID <input type="number" id="approve_club_id"></label>
    <button onclick="approveClub()">Approve</button>
    <pre id="admin_result"></pre>
    <div style="margin-top:12px;">
      <button onclick="loadFlags()">Load flagged content</button>
      <ul id="flagged_list"></ul>
    </div>
  </section>

<script>
  const API = "http://localhost:8000/api";
  let loadedClubId = null;
  let myRegistrations = new Map();
  let myEvents = [];
  let clubMemberships = new Map();
  let clubRoles = new Map();
  let myClubs = [];

  function isoPlusDays(days){
    const dt = new Date(Date.now() + days * 86400000);
    dt.setSeconds(0,0);
    return dt.toISOString();
  }

  document.getElementById("event_starts").value = isoPlusDays(2);
  document.getElementById("club_event_starts").value = isoPlusDays(5);

  function setPersona(email, role){
    document.getElementById("persona_email").value = email;
    document.getElementById("persona_role").value = role;
  }

  function buildHeaders(json=true){
    const headers = {
      "X-User-Email": document.getElementById("persona_email").value,
      "X-User-Role": document.getElementById("persona_role").value
    };
    if(json){ headers["Content-Type"] = "application/json"; }
    return headers;
  }

  function currentPersona(){
    return {
      email: document.getElementById("persona_email").value,
      role: document.getElementById("persona_role").value
    };
  }

  function canManageEvent(event){
    const persona = currentPersona();
    if(persona.role === "admin"){ return true; }
    if(!event.club_id){ return false; }
    const membershipRole = clubRoles.get(event.club_id);
    return persona.role === "leader" && membershipRole === "leader";
  }

  async function fetchMyRegistrations(renderList=false){
    try {
      const res = await fetch(`${API}/registrations/mine`, { headers: buildHeaders(false) });
      if(!res.ok){
        myRegistrations = new Map();
        myEvents = [];
        if(renderList){ renderMyEvents(); }
        return;
      }
      const data = await res.json();
      myRegistrations = new Map(data.map(r => [r.event.id, r.id]));
      myEvents = data.map(r => r.event);
      if(renderList){ renderMyEvents(); }
    } catch (err){
      console.error("Failed to load registrations", err);
      myRegistrations = new Map();
      myEvents = [];
      if(renderList){ renderMyEvents(); }
    }
  }

  function focusEvent(eventId){
    const row = document.getElementById(`event-row-${eventId}`);
    if(row){
      row.classList.add("highlight");
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      setTimeout(() => row.classList.remove("highlight"), 1600);
    } else {
      alert("Event not in the current results. Run a search that includes it to jump there.");
    }
  }

  function renderMyEvents(){
    const tbody = document.getElementById("my_events_tbody");
    tbody.innerHTML = "";
    if(myEvents.length === 0){
      tbody.innerHTML = '<tr><td colspan="4">No registrations yet for this persona.</td></tr>';
      return;
    }

    myEvents
      .slice()
      .sort((a,b) => new Date(a.starts_at) - new Date(b.starts_at))
      .forEach(ev => {
        const tr = document.createElement("tr");
        tr.classList.add("clickable-row");
        tr.onclick = () => focusEvent(ev.id);
        tr.innerHTML = `<td>${ev.title}</td><td>${new Date(ev.starts_at).toLocaleString()}</td><td>${ev.location}</td><td>${ev.category}</td>`;
        tbody.appendChild(tr);
      });
  }

  async function createEvent(){
    const payload = {
      title: document.getElementById("event_title").value,
      starts_at: document.getElementById("event_starts").value,
      location: document.getElementById("event_location").value,
      capacity: Number(document.getElementById("event_capacity").value),
      price_cents: Number(document.getElementById("event_price").value),
      category: document.getElementById("event_category").value,
      club_id: document.getElementById("event_club").value ? Number(document.getElementById("event_club").value) : null
    };
    const res = await fetch(`${API}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Create event: ${res.status}`);
    listEvents();
  }

  async function listEvents(skipRegistrationSync = false){
    const params = new URLSearchParams();
    const start = document.getElementById("filter_start").value;
    const end = document.getElementById("filter_end").value;
    const category = document.getElementById("filter_category").value;
    const location = document.getElementById("filter_location").value;
    const sort = document.getElementById("filter_sort").value;
    if(start) params.set("start", start);
    if(end) params.set("end", end);
    if(category) params.set("category", category);
    if(location) params.set("location", location);
    if(document.getElementById("filter_free").checked) params.set("free_only", true);
    if(sort) params.set("sort", sort);

    if(!skipRegistrationSync){
      await fetchMyRegistrations(false);
    }

    const res = await fetch(`${API}/events?${params.toString()}`);
    const data = await res.json();
    const tbody = document.getElementById("events_tbody");
    tbody.innerHTML = "";
    data.forEach(ev => {
      const tr = document.createElement("tr");
      tr.id = `event-row-${ev.id}`;
      tr.innerHTML = `<td>${ev.id}</td><td>${ev.title}</td><td>${new Date(ev.starts_at).toLocaleString()}</td>` +
                     `<td>${ev.location}</td><td>${ev.category}</td><td>${ev.club_id ?? '-'}</td>` +
                     `<td>${ev.capacity || '∞'}</td><td>${ev.registration_count}</td>`;

      const actionCell = document.createElement("td");
      const isRegistered = myRegistrations.has(ev.id);
      const regBtn = document.createElement("button");
      regBtn.textContent = isRegistered ? "Unregister" : "Register";
      regBtn.onclick = () => isRegistered ? unregisterEvent(ev.id) : registerEvent(ev.id);
      const flagBtn = document.createElement("button");
      flagBtn.textContent = "Flag";
      flagBtn.onclick = () => flagEvent(ev.id);
      actionCell.appendChild(regBtn);
      actionCell.appendChild(document.createTextNode(" "));
      actionCell.appendChild(flagBtn);
      if(canManageEvent(ev)){
        actionCell.appendChild(document.createTextNode(" "));
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteEvent(ev.id);
        actionCell.appendChild(deleteBtn);
      }
      tr.appendChild(actionCell);
      tbody.appendChild(tr);
    });
  }

  async function loadTrending(){
    const res = await fetch(`${API}/events/trending`);
    const data = await res.json();
    const ul = document.getElementById("trending_list");
    ul.innerHTML = "";
    data.forEach(ev => {
      const li = document.createElement("li");
      li.textContent = `${ev.title} (${ev.registration_count} regs)`;
      ul.appendChild(li);
    });
  }

  async function registerEvent(eventId){
    const res = await fetch(`${API}/registrations`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify({event_id: eventId})
    });
    const body = res.ok ? "Registered" : `Register failed: ${res.status}`;
    alert(body);
    await fetchMyRegistrations(true);
    await listEvents(true);
  }

  async function unregisterEvent(eventId){
    const res = await fetch(`${API}/registrations/${eventId}`, {
      method: "DELETE",
      headers: buildHeaders(false)
    });
    const body = res.ok ? "Unregistered" : `Unregister failed: ${res.status}`;
    alert(body);
    await fetchMyRegistrations(true);
    await listEvents(true);
  }

  async function deleteEvent(eventId){
    if(!confirm("Delete this event?")){ return; }
    const res = await fetch(`${API}/events/${eventId}`, {
      method: "DELETE",
      headers: buildHeaders(false)
    });
    const detail = await res.json().catch(() => ({}));
    const message = res.ok ? "Event deleted" : `Delete failed: ${res.status}${detail.detail ? ` - ${detail.detail}` : ''}`;
    alert(message);
    await fetchMyRegistrations(true);
    await listEvents();
    if(loadedClubId){
      await loadClubDetail();
    }
  }

  async function loadMyEvents(){
    await fetchMyRegistrations(true);
  }

  function renderClubs(clubs){
    const ul = document.getElementById("club_list");
    ul.innerHTML = "";
    if(clubs.length === 0){
      ul.innerHTML = '<li>No clubs found.</li>';
      return;
    }

    clubs.forEach(club => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${club.name}</strong> — ${club.description}<br>` +
                     `Members: ${club.member_count} | Upcoming events: ${club.upcoming_event_count}`;
      const action = document.createElement("div");
      const status = clubMemberships.get(club.id);
      const btn = document.createElement("button");
      if(status === "approved"){
        btn.textContent = "Leave";
        btn.onclick = () => leaveClub(club.id);
      } else if(status === "pending"){
        btn.textContent = "Pending";
        btn.disabled = true;
      } else {
        btn.textContent = "Join";
        btn.onclick = () => joinClub(club.id);
      }
      action.appendChild(btn);
      li.appendChild(action);
      ul.appendChild(li);
    });
  }

  async function loadClubs(){
    const res = await fetch(`${API}/clubs`, { headers: buildHeaders(false) });
    const data = await res.json();
    clubMemberships = new Map(data.map(club => [club.id, club.membership_status]));
    clubRoles = new Map(data.map(club => [club.id, club.membership_role]));
    renderClubs(data);
  }

  function renderMyClubs(){
    const ul = document.getElementById("my_club_list");
    ul.innerHTML = "";
    if(myClubs.length === 0){
      ul.innerHTML = '<li>No approved club memberships for this persona yet.</li>';
      return;
    }
    myClubs.forEach(club => {
      const li = document.createElement("li");
      li.textContent = `${club.name} — ${club.description}`;
      ul.appendChild(li);
    });
  }

  async function loadMyClubs(){
    try {
      const res = await fetch(`${API}/clubs/mine`, { headers: buildHeaders(false) });
      if(!res.ok){
        myClubs = [];
      } else {
        myClubs = await res.json();
      }
    } catch (err){
      console.error("Failed to load my clubs", err);
      myClubs = [];
    }
    renderMyClubs();
  }

  async function createClub(){
    const payload = {
      name: document.getElementById("club_name").value,
      description: document.getElementById("club_desc").value
    };
    const res = await fetch(`${API}/clubs`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    document.getElementById("club_create_result").textContent = JSON.stringify(await res.json(), null, 2);
    loadPendingClubs();
  }

  async function joinClub(id){
    const clubId = id ?? Number(document.getElementById("join_club_id").value);
    if(!clubId){ return; }
    const res = await fetch(`${API}/clubs/${clubId}/join`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    const body = await res.json();
    document.getElementById("club_join_result").textContent = JSON.stringify(body, null, 2);
    alert(`Join request: ${res.status}`);
    await loadClubs();
    await loadMyClubs();
  }

  async function leaveClub(id){
    if(!id){ return; }
    const res = await fetch(`${API}/clubs/${id}/leave`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    const body = await res.json();
    document.getElementById("club_join_result").textContent = JSON.stringify(body, null, 2);
    alert(res.ok ? "Left club" : `Leave failed: ${res.status}`);
    await loadClubs();
    await loadMyClubs();
  }

  async function loadClubDetail(){
    const id = Number(document.getElementById("club_detail_id").value);
    if(!id){ return; }
    const res = await fetch(`${API}/clubs/${id}`, { headers: buildHeaders(false) });
    const data = await res.json();
    loadedClubId = id;
    const div = document.getElementById("club_detail");
    const members = data.members.map(m => `${m.user_email} (${m.role}, ${m.status})`).join(', ') || '—';
    const announcements = data.announcements.map(a => `<li><strong>${a.title}</strong> — ${a.body} <button onclick=\"flagAnnouncement(${a.id})\">Flag</button></li>`).join('');
    const persona = currentPersona();
    const isClubLeader = data.members.some(m => m.user_email === persona.email && m.role === "leader" && m.status === "approved");
    const canManageClubEvents = persona.role === "admin" || isClubLeader;
    const events = data.events
      .map(ev => {
        const deleteBtn = canManageClubEvents ? ` <button onclick="deleteEvent(${ev.id})">Delete</button>` : '';
        return `<li>${ev.title} (${new Date(ev.starts_at).toLocaleDateString()}) cap ${ev.capacity} regs ${ev.registration_count}${deleteBtn}</li>`;
      })
      .join('');
    const pendingMembers = data.members.filter(m => m.status === "pending");
    const role = persona.role;
    const pendingList = pendingMembers.length
      ? pendingMembers.map(m => `<li>${m.user_email} (${m.role}) <button onclick=\"approveMember('${m.user_email}')\">Approve</button></li>`).join('')
      : '<li>No pending requests</li>';
    const pendingSection = ["leader", "admin"].includes(role)
      ? `<div><h4>Pending members</h4><ul>${pendingList}</ul></div>`
      : '';
    div.innerHTML = `
      <h3>${data.club.name} ${data.club.approved ? '' : '(pending)'}</h3>
      <p>${data.club.description}</p>
      ${pendingSection}
      <p><strong>Members:</strong> ${members}</p>
      <div>
        <h4>Announcements</h4>
        <ul>${announcements || '<li>No announcements</li>'}</ul>
      </div>
      <div>
        <h4>Upcoming events</h4>
        <ul>${events || '<li>No upcoming events</li>'}</ul>
      </div>
    `;
  }

  async function approveMember(emailOverride){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const email = emailOverride ?? document.getElementById("approve_email").value;
    const res = await fetch(`${API}/clubs/${loadedClubId}/members/${encodeURIComponent(email)}/approve`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    alert(`Approve member: ${res.status}`);
    loadClubDetail();
  }

  async function postAnnouncement(){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const payload = {
      title: document.getElementById("ann_title").value,
      body: document.getElementById("ann_body").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/announcements`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Announcement: ${res.status}`);
    loadClubDetail();
  }

  async function createClubEvent(){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const payload = {
      title: document.getElementById("club_event_title").value,
      starts_at: document.getElementById("club_event_starts").value,
      location: document.getElementById("club_event_location").value,
      capacity: Number(document.getElementById("club_event_capacity").value),
      price_cents: Number(document.getElementById("club_event_price").value),
      category: document.getElementById("club_event_category").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Club event: ${res.status}`);
    loadClubDetail();
  }

  async function flagEvent(id){
    const reason = prompt("Why are you flagging this event?");
    if(!reason){ return; }
    try {
      const res = await fetch(`${API}/flags`, {
        method: "POST",
        headers: buildHeaders(true),
        body: JSON.stringify({ item_type: "event", item_id: id, reason })
      });
      alert(res.ok ? "Flag submitted" : `Flag failed: ${res.status}`);
    } catch (err){
      alert("Flag failed");
    }
  }

  async function flagAnnouncement(id){
    const reason = prompt("Why are you flagging this announcement?");
    if(!reason){ return; }
    try {
      const res = await fetch(`${API}/flags`, {
        method: "POST",
        headers: buildHeaders(true),
        body: JSON.stringify({ item_type: "announcement", item_id: id, reason })
      });
      alert(res.ok ? "Flag submitted" : `Flag failed: ${res.status}`);
    } catch (err){
      alert("Flag failed");
    }
  }

  async function loadFlags(){
    const res = await fetch(`${API}/admin/flags`, { headers: buildHeaders(false) });
    const ul = document.getElementById("flagged_list");
    ul.innerHTML = "";
    if(res.status === 403){
      ul.innerHTML = '<li>Admin role required</li>';
      return;
    }
    const data = await res.json();
    data.forEach(flag => {
      const li = document.createElement("li");
      li.innerHTML = `${flag.item_type} #${flag.item_id} — ${flag.reason} (${flag.user_email}) on ${new Date(flag.created_at).toLocaleString()} ` +
                     `<button onclick="resolveFlag(${flag.id})">Resolve</button>`;
      ul.appendChild(li);
    });
  }

  async function resolveFlag(id){
    await fetch(`${API}/admin/flags/${id}/resolve`, { method: "POST", headers: buildHeaders(false) });
    loadFlags();
  }

  async function loadPendingClubs(){
    const res = await fetch(`${API}/admin/clubs/pending`, { headers: buildHeaders(false) });
    if(res.status === 403){
      document.getElementById("pending_club_list").innerHTML = '<li>Admin role required</li>';
      return;
    }
    const data = await res.json();
    const ul = document.getElementById("pending_club_list");
    ul.innerHTML = "";
    data.forEach(club => {
      const li = document.createElement("li");
      li.textContent = `${club.id} — ${club.name} (${club.member_count} approved members)`;
      ul.appendChild(li);
    });
  }

  async function approveClub(){
    const id = Number(document.getElementById("approve_club_id").value);
    const res = await fetch(`${API}/admin/clubs/${id}/approve`, {
      method: "POST",
      headers: buildHeaders(false)
    });
    document.getElementById("admin_result").textContent = JSON.stringify(await res.json(), null, 2);
    loadClubs();
    loadPendingClubs();
  }

  // initial data
  listEvents();
  loadTrending();
  loadClubs();
  loadMyClubs();
  loadClubDetail();
</script>
</body>
</html>
