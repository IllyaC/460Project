<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Campus Clubs & Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #0f172a;
      background-color: #eff6ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #dbeafe 0%, #eff6ff 45%, #fff 100%);
      color: #0f172a;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }
    .hero {
      text-align: center;
      padding: 32px 20px 20px;
    }
    .hero h1 {
      font-size: clamp(2.2rem, 3vw, 3rem);
      margin-bottom: 12px;
      color: #0b1a35;
    }
    .hero p {
      color: #475569;
      font-size: 1.05rem;
      margin: 0 auto;
      max-width: 760px;
    }
    .persona-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(15,23,42,0.08);
      border: 1px solid rgba(148,163,184,0.25);
    }
    .card h3 { margin-top: 0; }
    .card p { color: #475569; }
    button, select, input, textarea {
      font: inherit;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      padding: 10px 14px;
      width: 100%;
    }
    button {
      border: none;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      width: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button.secondary {
      background: rgba(37,99,235,0.08);
      color: #1d4ed8;
      border: 1px solid rgba(37,99,235,0.25);
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 20px rgba(37,99,235,0.18);
    }
    label { font-weight: 600; display: block; margin-top: 14px; color: #0f172a; }
    label span { display: block; font-weight: 400; color: #475569; margin-bottom: 4px; }
    textarea { min-height: 120px; resize: vertical; }
    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.95rem;
    }
    th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    ul { padding-left: 20px; color: #1e293b; }
    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 14px;
      border-radius: 14px;
      overflow: auto;
    }
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(15,23,42,0.08);
      color: #0f172a;
    }
    .hidden { display: none !important; }
    #app_main[hidden] { display: none; }
    #landing[hidden] { display: none; }
    .stack { display: flex; flex-direction: column; gap: 16px; }
    .quick-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .subtle { color: #475569; font-size: 0.85rem; margin-top: 6px; display: block; }
    .login-hint { font-size: 0.85rem; color: #475569; margin-top: 8px; }
    .credential-list { list-style: none; padding-left: 0; font-size: 0.9rem; }
    .credential-list li { margin-bottom: 6px; }
    .credential-list code { background: rgba(15,23,42,0.08); padding: 2px 6px; border-radius: 6px; }
    .error { color: #dc2626; font-weight: 600; margin-top: 6px; }
    @media (max-width: 640px) {
      .section-title { flex-direction: column; align-items: flex-start; gap: 10px; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="hero">
      <p class="pill">Campus Clubs Platform</p>
      <h1>Choose your experience</h1>
      <p>Explore upcoming events as a student, manage members as a club leader, or review approvals as an administrator — each dashboard is tailored to what you need.</p>
    </header>

    <section id="landing" class="persona-grid">
      <article class="card" style="grid-column: 1 / -1;">
        <p class="pill">Demo login</p>
        <h3>Authenticate to continue</h3>
        <p>Use the credentials below to simulate each persona. The portal stays hidden until a valid login occurs.</p>
        <form id="login_form" onsubmit="handleLogin(event)" class="stack">
          <label><span>Email</span><input id="login_email" autocomplete="username"></label>
          <label><span>Password</span><input id="login_password" type="password" autocomplete="current-password"></label>
          <button type="submit">Sign in</button>
          <p id="login_error" class="error" aria-live="polite"></p>
        </form>
        <p class="login-hint">Available demo users (<code>email</code> / <code>password</code>):</p>
        <ul id="credential_list" class="credential-list"></ul>
      </article>
      <article class="card">
        <p class="pill">Student</p>
        <h3>Discover events & clubs</h3>
        <p>Browse trending events, register instantly, and find clubs to join that match your interests.</p>
        <button type="button" onclick="fillLogin('student')">Fill with student login</button>
      </article>
      <article class="card">
        <p class="pill">Club Leader</p>
        <h3>Manage your community</h3>
        <p>Approve new members, publish announcements, and schedule club-hosted meetups.</p>
        <button type="button" onclick="fillLogin('leader')">Fill with leader login</button>
      </article>
      <article class="card">
        <p class="pill">Admin</p>
        <h3>Review pending clubs</h3>
        <p>Quickly approve submissions, monitor participation, and keep the campus directory curated.</p>
        <button type="button" onclick="fillLogin('admin')">Fill with admin login</button>
      </article>
    </section>

    <main id="app_main" hidden>
      <section class="card stack" data-for="all">
        <div class="section-title">
          <div>
            <p class="pill">Signed in as <span id="active_role">Student</span></p>
            <small class="subtle">Update the persona headers to test different permissions.</small>
          </div>
          <div class="quick-actions">
            <button class="secondary" type="button" onclick="logout()">← Log out</button>
          </div>
        </div>
        <div class="panel-grid">
          <div>
            <label><span>Email address</span><input id="persona_email" value="" readonly></label>
          </div>
          <div>
            <label><span>Role</span>
              <select id="persona_role" disabled>
                <option value="student">student</option>
                <option value="leader">leader</option>
                <option value="admin">admin</option>
              </select>
            </label>
          </div>
        </div>
        <small class="subtle">These values are sent as <code>X-User-Email</code> and <code>X-User-Role</code> headers.</small>
      </section>

      <section class="card stack" data-for="student,leader">
        <div class="section-title">
          <h2>Discover events</h2>
          <div class="quick-actions">
            <button type="button" onclick="listEvents()">Refresh list</button>
            <button type="button" class="secondary" onclick="loadTrending()">See trending</button>
          </div>
        </div>
        <div class="panel-grid">
          <div>
            <label><span>Starts after</span><input id="filter_start" placeholder="2024-09-01T00:00:00Z"></label>
            <label><span>Ends before</span><input id="filter_end" placeholder="2024-09-30T23:59:59Z"></label>
            <label><span>Category</span><input id="filter_category" placeholder="tech"></label>
            <label><span>Location contains</span><input id="filter_location" placeholder="ENG"></label>
            <label><span>Sort</span>
              <select id="filter_sort">
                <option value="date">date</option>
                <option value="popularity">popularity</option>
              </select>
            </label>
            <label><input type="checkbox" id="filter_free"> Free only</label>
            <button type="button" onclick="listEvents()">Run search</button>
          </div>
          <div>
            <h3>Create event</h3>
            <label><span>Title</span><input id="event_title" value="Hack Night"></label>
            <label><span>Starts at</span><input id="event_starts"></label>
            <label><span>Location</span><input id="event_location" value="Student Union"></label>
            <label><span>Capacity</span><input type="number" id="event_capacity" value="5"></label>
            <label><span>Price (cents)</span><input type="number" id="event_price" value="0"></label>
            <label><span>Category</span><input id="event_category" value="tech"></label>
            <label><span>Club ID (optional)</span><input type="number" id="event_club"></label>
            <div class="quick-actions">
              <button type="button" onclick="createEvent()">Create event</button>
              <button type="button" class="secondary" onclick="registerEvent()">Register for ID below</button>
            </div>
            <label><span>Event ID to register</span><input type="number" id="register_event_id" value="1"></label>
          </div>
        </div>
        <div class="panel-grid">
          <div style="grid-column: 1 / -1;">
            <table>
              <thead>
                <tr><th>ID</th><th>Title</th><th>When</th><th>Location</th><th>Category</th><th>Club</th><th>Capacity</th><th>Registered</th></tr>
              </thead>
              <tbody id="events_tbody"></tbody>
            </table>
          </div>
          <div>
            <h3>Trending now</h3>
            <ul id="trending_list"></ul>
          </div>
        </div>
      </section>

      <section class="card stack" data-for="student,leader">
        <div class="section-title">
          <h2>Clubs directory</h2>
          <button type="button" onclick="loadClubs()">Refresh clubs</button>
        </div>
        <div class="panel-grid">
          <div>
            <ul id="club_list"></ul>
          </div>
          <div>
            <h3>Create a club</h3>
            <label><span>Name</span><input id="club_name" placeholder="Board Games"></label>
            <label><span>Description</span><textarea id="club_desc" placeholder="What does this club do?"></textarea></label>
            <button type="button" onclick="createClub()">Submit for approval</button>
            <pre id="club_create_result"></pre>
            <h3>Join a club</h3>
            <label><span>Club ID</span><input type="number" id="join_club_id"></label>
            <button type="button" onclick="joinClub()">Request to join</button>
            <pre id="club_join_result"></pre>
          </div>
        </div>
      </section>

      <section class="card stack" data-for="leader">
        <div class="section-title">
          <h2>Your club tools</h2>
          <button type="button" onclick="loadClubDetail()">Reload club</button>
        </div>
        <div class="panel-grid">
          <div>
            <label><span>Club ID</span><input type="number" id="club_detail_id" value="1"></label>
            <button type="button" onclick="loadClubDetail()">Load club</button>
            <div id="club_detail"></div>
          </div>
          <div>
            <h3>Approve & announce</h3>
            <label><span>Approve member email</span><input id="approve_email" placeholder="student@example.edu"></label>
            <button type="button" onclick="approveMember()">Approve member</button>
            <label><span>Announcement title</span><input id="ann_title"></label>
            <label><span>Announcement body</span><textarea id="ann_body"></textarea></label>
            <button type="button" onclick="postAnnouncement()">Publish update</button>
          </div>
          <div>
            <h3>Schedule club event</h3>
            <label><span>Title</span><input id="club_event_title" value="Study Session"></label>
            <label><span>Starts at</span><input id="club_event_starts"></label>
            <label><span>Location</span><input id="club_event_location" value="Library 201"></label>
            <label><span>Capacity</span><input type="number" id="club_event_capacity" value="10"></label>
            <label><span>Price (cents)</span><input type="number" id="club_event_price" value="0"></label>
            <label><span>Category</span><input id="club_event_category" value="community"></label>
            <button type="button" onclick="createClubEvent()">Create event</button>
          </div>
        </div>
      </section>

      <section class="card stack" data-for="admin">
        <div class="section-title">
          <h2>Admin dashboard</h2>
          <button type="button" onclick="loadPendingClubs()">Load pending clubs</button>
        </div>
        <div class="panel-grid">
          <div>
            <ul id="pending_club_list"></ul>
          </div>
          <div>
            <label><span>Approve club ID</span><input type="number" id="approve_club_id"></label>
            <button type="button" onclick="approveClub()">Approve selected</button>
            <pre id="admin_result"></pre>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
  const API = "http://localhost:8000/api";
  let loadedClubId = null;
  let credentialStore = new Map();
  let demoUsers = [];
  let activeUser = null;

  function isoPlusDays(days){
    const dt = new Date(Date.now() + days * 86400000);
    dt.setSeconds(0,0);
    return dt.toISOString();
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("event_starts").value = isoPlusDays(2);
    document.getElementById("club_event_starts").value = isoPlusDays(5);
    loadDemoCredentials();
  });

  function setPersona(email, role){
    document.getElementById("persona_email").value = email;
    document.getElementById("persona_role").value = role;
    updateRoleSections(role);
  }

  async function loadDemoCredentials(){
    try {
      const res = await fetch("demo-credentials.txt");
      const text = await res.text();
      credentialStore = new Map();
      demoUsers = [];
      text.split(/\r?\n/).forEach(line => {
        const trimmed = line.trim();
        if(!trimmed || trimmed.startsWith("#")) return;
        const [email, role, password] = trimmed.split(",").map(v => v.trim());
        if(email && role && password){
          const record = { email, role, password };
          credentialStore.set(email.toLowerCase(), record);
          demoUsers.push(record);
        }
      });
      renderCredentialList();
    } catch(err){
      document.getElementById("credential_list").innerHTML = '<li>Unable to load demo credentials</li>';
    }
  }

  function renderCredentialList(){
    const list = document.getElementById("credential_list");
    list.innerHTML = "";
    demoUsers.forEach(user => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${user.role}</strong>: <code>${user.email}</code> / <code>${user.password}</code>`;
      list.appendChild(li);
    });
    const defaultStudent = demoUsers.find(user => user.role === "student");
    if(defaultStudent){
      document.getElementById("login_email").value = defaultStudent.email;
      document.getElementById("login_password").value = defaultStudent.password;
    }
  }

  function handleLogin(event){
    event.preventDefault();
    const email = document.getElementById("login_email").value.trim();
    const password = document.getElementById("login_password").value.trim();
    const record = credentialStore.get(email.toLowerCase());
    const errorEl = document.getElementById("login_error");
    if(!record || record.password !== password){
      errorEl.textContent = "Invalid email or password";
      return;
    }
    errorEl.textContent = "";
    completeLogin(record);
  }

  function completeLogin(user){
    activeUser = user;
    setPersona(user.email, user.role);
    document.getElementById("landing").hidden = true;
    document.getElementById("app_main").hidden = false;
    document.getElementById("login_password").value = "";
    loadInitialData();
  }

  function loadInitialData(){
    listEvents();
    loadTrending();
    loadClubs();
    loadClubDetail();
    if(activeUser?.role === "admin"){
      loadPendingClubs();
    } else {
      document.getElementById("pending_club_list").innerHTML = "";
    }
  }

  function fillLogin(role){
    const user = demoUsers.find(u => u.role === role);
    if(!user){ return; }
    document.getElementById("login_email").value = user.email;
    document.getElementById("login_password").value = user.password;
  }

  function buildHeaders(json=true){
    const headers = {
      "X-User-Email": document.getElementById("persona_email").value,
      "X-User-Role": document.getElementById("persona_role").value
    };
    if(json){ headers["Content-Type"] = "application/json"; }
    return headers;
  }

  function logout(){
    activeUser = null;
    loadedClubId = null;
    document.getElementById("app_main").hidden = true;
    document.getElementById("landing").hidden = false;
    document.getElementById("persona_email").value = "";
    document.getElementById("persona_role").value = "student";
    document.getElementById("pending_club_list").innerHTML = "";
    document.getElementById("admin_result").textContent = "";
  }

  function updateRoleSections(role){
    document.getElementById("active_role").textContent = role.charAt(0).toUpperCase() + role.slice(1);
    document.querySelectorAll('[data-for]').forEach(section => {
      const roles = section.dataset.for.split(',').map(r => r.trim());
      section.hidden = !(roles.includes(role) || roles.includes("all"));
    });
  }

  document.getElementById("persona_role").addEventListener("change", (event) => {
    updateRoleSections(event.target.value);
  });

  updateRoleSections(document.getElementById("persona_role").value);

  async function createEvent(){
    const payload = {
      title: document.getElementById("event_title").value,
      starts_at: document.getElementById("event_starts").value,
      location: document.getElementById("event_location").value,
      capacity: Number(document.getElementById("event_capacity").value),
      price_cents: Number(document.getElementById("event_price").value),
      category: document.getElementById("event_category").value,
      club_id: document.getElementById("event_club").value ? Number(document.getElementById("event_club").value) : null
    };
    const res = await fetch(`${API}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Create event: ${res.status}`);
    listEvents();
  }

  async function listEvents(){
    const params = new URLSearchParams();
    const start = document.getElementById("filter_start").value;
    const end = document.getElementById("filter_end").value;
    const category = document.getElementById("filter_category").value;
    const location = document.getElementById("filter_location").value;
    const sort = document.getElementById("filter_sort").value;
    if(start) params.set("start", start);
    if(end) params.set("end", end);
    if(category) params.set("category", category);
    if(location) params.set("location", location);
    if(document.getElementById("filter_free").checked) params.set("free_only", true);
    if(sort) params.set("sort", sort);
    const res = await fetch(`${API}/events?${params.toString()}`);
    const data = await res.json();
    const tbody = document.getElementById("events_tbody");
    tbody.innerHTML = "";
    data.forEach(ev => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ev.id}</td><td>${ev.title}</td><td>${new Date(ev.starts_at).toLocaleString()}</td>` +
                     `<td>${ev.location}</td><td>${ev.category}</td><td>${ev.club_id ?? '-'}</td>` +
                     `<td>${ev.capacity || '∞'}</td><td>${ev.registration_count}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadTrending(){
    const res = await fetch(`${API}/events/trending`);
    const data = await res.json();
    const ul = document.getElementById("trending_list");
    ul.innerHTML = "";
    data.forEach(ev => {
      const li = document.createElement("li");
      li.textContent = `${ev.title} (${ev.registration_count} regs)`;
      ul.appendChild(li);
    });
  }

  async function registerEvent(){
    const id = Number(document.getElementById("register_event_id").value);
    const res = await fetch(`${API}/registrations`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify({event_id: id})
    });
    alert(`Register: ${res.status}`);
    listEvents();
  }

  async function loadClubs(){
    const res = await fetch(`${API}/clubs`);
    const data = await res.json();
    const ul = document.getElementById("club_list");
    ul.innerHTML = "";
    data.forEach(club => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${club.name}</strong> — ${club.description}<br>` +
                     `Members: ${club.member_count} | Upcoming events: ${club.upcoming_event_count}`;
      ul.appendChild(li);
    });
  }

  async function createClub(){
    const payload = {
      name: document.getElementById("club_name").value,
      description: document.getElementById("club_desc").value
    };
    const res = await fetch(`${API}/clubs`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    document.getElementById("club_create_result").textContent = JSON.stringify(await res.json(), null, 2);
    loadPendingClubs();
  }

  async function joinClub(){
    const id = Number(document.getElementById("join_club_id").value);
    const res = await fetch(`${API}/clubs/${id}/join`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    document.getElementById("club_join_result").textContent = JSON.stringify(await res.json(), null, 2);
  }

  async function loadClubDetail(){
    const id = Number(document.getElementById("club_detail_id").value);
    if(!id){ return; }
    const res = await fetch(`${API}/clubs/${id}`);
    const data = await res.json();
    loadedClubId = id;
    const div = document.getElementById("club_detail");
    const members = data.members.map(m => `${m.user_email} (${m.role})`).join(', ') || '—';
    const announcements = data.announcements.map(a => `<li><strong>${a.title}</strong> — ${a.body}</li>`).join('');
    const events = data.events.map(ev => `<li>${ev.title} (${new Date(ev.starts_at).toLocaleDateString()}) cap ${ev.capacity} regs ${ev.registration_count}</li>`).join('');
    div.innerHTML = `
      <h3>${data.club.name} ${data.club.approved ? '' : '(pending)'}</h3>
      <p>${data.club.description}</p>
      <p><strong>Members:</strong> ${members}</p>
      <div>
        <h4>Announcements</h4>
        <ul>${announcements || '<li>No announcements</li>'}</ul>
      </div>
      <div>
        <h4>Upcoming events</h4>
        <ul>${events || '<li>No upcoming events</li>'}</ul>
      </div>
    `;
  }

  async function approveMember(){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const email = document.getElementById("approve_email").value;
    const res = await fetch(`${API}/clubs/${loadedClubId}/members/${encodeURIComponent(email)}/approve`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    alert(`Approve member: ${res.status}`);
    loadClubDetail();
  }

  async function postAnnouncement(){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const payload = {
      title: document.getElementById("ann_title").value,
      body: document.getElementById("ann_body").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/announcements`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Announcement: ${res.status}`);
    loadClubDetail();
  }

  async function createClubEvent(){
    if(!loadedClubId){ alert('Load a club first'); return; }
    const payload = {
      title: document.getElementById("club_event_title").value,
      starts_at: document.getElementById("club_event_starts").value,
      location: document.getElementById("club_event_location").value,
      capacity: Number(document.getElementById("club_event_capacity").value),
      price_cents: Number(document.getElementById("club_event_price").value),
      category: document.getElementById("club_event_category").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    alert(`Club event: ${res.status}`);
    loadClubDetail();
  }

  async function loadPendingClubs(){
    const res = await fetch(`${API}/admin/clubs/pending`, { headers: buildHeaders(false) });
    if(res.status === 403){
      document.getElementById("pending_club_list").innerHTML = '<li>Admin role required</li>';
      return;
    }
    const data = await res.json();
    const ul = document.getElementById("pending_club_list");
    ul.innerHTML = "";
    data.forEach(club => {
      const li = document.createElement("li");
      li.textContent = `${club.id} — ${club.name} (${club.member_count} approved members)`;
      ul.appendChild(li);
    });
  }

  async function approveClub(){
    const id = Number(document.getElementById("approve_club_id").value);
    const res = await fetch(`${API}/admin/clubs/${id}/approve`, {
      method: "POST",
      headers: buildHeaders(false)
    });
    document.getElementById("admin_result").textContent = JSON.stringify(await res.json(), null, 2);
    loadClubs();
    loadPendingClubs();
  }

  // initial data loads once a persona logs in via handleLogin()
</script>
</body>
</html>
