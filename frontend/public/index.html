<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Campus Clubs & Events — Phase 2 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="page-hero">
    <div>
      <p class="eyebrow">Campus Life</p>
      <h1>Campus Clubs & Events</h1>
      <p class="lead">Discover events, find your people, and keep campus life organized.</p>
    </div>
    <div id="top_bar" class="top-bar hidden">
      <div id="user_summary" class="user-summary"></div>
      <a href="#" id="switch_user_link" class="switch-user" onclick="switchUser(event)">Switch user</a>
    </div>
  </header>

  <section id="login_section">
    <h2>Login</h2>
    <p>Choose who you want to explore the campus portal as.</p>
    <div class="row">
      <div>
        <label>Name <input id="login_name" placeholder="Jordan Rivera"></label>
        <label>Email <input id="login_email" placeholder="student@example.edu"></label>
        <label>Role
          <select id="login_role">
            <option value="student">Student</option>
            <option value="leader">Club Leader</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <button type="button" onclick="handleLogin()">Continue</button>
        <p id="login_status" class="status" aria-live="polite"></p>
      </div>
    </div>
  </section>

  <div id="app_shell" class="hidden">

  <nav class="nav-bar">
    <button type="button" class="nav-button" id="nav-events" data-target="events" onclick="showNavSection('events')">Events</button>
    <button type="button" class="nav-button" id="nav-clubs" data-target="clubs" onclick="showNavSection('clubs')">Clubs</button>
    <button type="button" class="nav-button" id="nav-mystuff" data-target="mystuff" onclick="showNavSection('mystuff')">My Stuff</button>
    <button type="button" class="nav-button admin-only" id="nav-admin" data-target="admin" onclick="showNavSection('admin')">Admin</button>
  </nav>

  <section data-section-group="events" class="content-section">
    <div class="section-header">
      <p class="eyebrow">Events</p>
      <div>
        <h2>Discover Events</h2>
        <p id="events_status" class="status" aria-live="polite"></p>
        <p>Search for something to attend, or add something new to the calendar.</p>
      </div>
    </div>
    <div class="row card-grid">
      <div class="panel filter-panel">
        <div class="section-header compact">
          <div>
            <p class="eyebrow">Find Events</p>
            <h3>Search & Filter</h3>
            <p class="hint">Dial in the dates, categories, and locations to find the right fit.</p>
          </div>
          <button type="button" class="btn-ghost" onclick="loadTrending()">Trending</button>
        </div>
        <div class="filter-grid">
          <div class="filter-cluster">
            <p class="cluster-label">Dates</p>
            <label>Starts after <input id="filter_start" placeholder="e.g., 2024-09-01T08:00:00Z"></label>
            <label>Ends before <input id="filter_end" placeholder="e.g., 2024-09-30T23:59:59Z"></label>
          </div>
          <div class="filter-cluster">
            <p class="cluster-label">Details</p>
            <label>Category
              <select id="filter_category">
                <option value="">Any category</option>
                <option value="music">music</option>
                <option value="tech">tech</option>
                <option value="sports">sports</option>
                <option value="social">social</option>
                <option value="career">career</option>
                <option value="other">other</option>
              </select>
            </label>
            <label>Title contains <input id="filter_title" placeholder="Workshop, social, meetup"></label>
            <label>Location contains <input id="filter_location" placeholder="Student Union, ENG, etc."></label>
          </div>
          <div class="filter-cluster">
            <p class="cluster-label">Preferences</p>
            <label class="checkbox-inline"><input type="checkbox" id="filter_free"> Free events only</label>
            <label>Sort by
              <select id="filter_sort">
                <option value="date">Date</option>
                <option value="popularity">Popularity</option>
              </select>
            </label>
          </div>
        </div>
        <div class="button-row">
          <button type="button" class="btn-primary" onclick="loadEvents()">Search</button>
          <button type="button" class="btn-secondary" onclick="resetFilters()">Reset filters</button>
          <button type="button" class="btn-ghost" onclick="loadTrending()">See trending</button>
        </div>
      </div>
      <div class="panel">
        <h3>Create Event</h3>
        <p class="hint">Share a meetup, workshop, or social and put it on the radar.</p>
        <label>Title <input id="event_title" value="Hack Night"></label>
        <label>Starts At <input id="event_starts"></label>
        <label>Location <input id="event_location" value="Student Union"></label>
        <label>Capacity <input type="number" id="event_capacity" value="5"></label>
        <label>Price (cents) <input type="number" id="event_price" value="0"></label>
        <label>Category <input id="event_category" value="tech"></label>
        <label>Club ID (optional) <input type="number" id="event_club"></label>
        <div class="button-row">
          <button onclick="createEvent()">Create Event</button>
        </div>
      </div>
    </div>
    <div class="panel table-panel">
      <div class="section-header compact">
        <div>
          <p class="eyebrow">Results</p>
          <h3>Upcoming Events</h3>
        </div>
        <button type="button" class="btn-secondary" onclick="loadEvents()">Refresh</button>
      </div>
      <div id="events_list" class="event-list" aria-live="polite"></div>
    </div>
    <div class="panel">
      <div class="section-header compact">
        <div>
          <p class="eyebrow">Now popular</p>
          <h3>Trending Events</h3>
        </div>
        <button type="button" onclick="loadTrending()">Refresh Trending</button>
      </div>
      <ul id="trending_list" class="card-list compact-list"></ul>
    </div>
  </section>

  <section data-section-group="clubs" class="content-section">
    <div class="section-header">
      <p class="eyebrow">Clubs</p>
      <div>
        <h2>Clubs Directory</h2>
        <p id="clubs_status" class="status" aria-live="polite"></p>
        <p>Browse campus groups, join a club, or manage your own.</p>
      </div>
    </div>
    <div class="row card-grid">
      <div class="panel">
        <div class="section-header compact">
          <div>
            <h3>Clubs Directory</h3>
            <p class="hint">Join or leave clubs straight from the list.</p>
          </div>
          <div class="toolbar">
            <label class="search-field">
              <span class="sr-only">Search clubs</span>
              <input id="club_search" type="search" placeholder="Search clubs" oninput="filterClubList()" aria-label="Search clubs">
            </label>
            <button onclick="loadClubs()">Refresh Clubs</button>
          </div>
        </div>
        <ul id="club_list" class="card-list"></ul>
      </div>
      <div class="panel">
        <h3>Start or Join a Club</h3>
        <p class="hint">Create something new or request membership.</p>
        <label>Name <input id="club_name" placeholder="Board Games"></label>
        <label>Description <textarea id="club_desc" placeholder="What does this club do?"></textarea></label>
        <button onclick="createClub()">Submit Club (pending approval)</button>
        <p id="club_create_result" class="status" aria-live="polite"></p>
        <h4>Join a club</h4>
        <label>Club ID <input type="number" id="join_club_id"></label>
        <button onclick="joinClub()">Request to Join</button>
        <p id="club_join_result" class="status" aria-live="polite"></p>
      </div>
    </div>

    <div class="panel">
      <div class="section-header compact">
        <div>
          <h3>Club Detail</h3>
          <p class="hint">Inspect a specific club and use leader tools when available.</p>
        </div>
        <div class="button-row inline">
          <label>Club ID <input type="number" id="club_detail_id" value="1"></label>
          <button onclick="loadClubDetail()">Load Club</button>
        </div>
      </div>
      <p id="club_detail_status" class="status" aria-live="polite"></p>
      <div id="club_detail" class="club-detail"></div>

      <div id="leader_dashboard" class="leader-dashboard leader-only hidden">
        <div class="section-header compact">
          <div>
            <p class="eyebrow">Leader Dashboard</p>
            <h3>Manage Events, Members, and Updates</h3>
            <p class="hint">Create club events, approve membership requests, and share announcements.</p>
          </div>
        </div>
        <div class="leader-dashboard__grid">
          <div class="panel leader-card">
            <p class="eyebrow">Create Event</p>
            <h4>Schedule Club Event</h4>
            <p class="hint">Share dates, locations, and capacity for upcoming meetups.</p>
            <div class="form-grid">
              <label>Title <input id="club_event_title" value="Study Session"></label>
              <label>Starts At <input id="club_event_starts"></label>
              <label>Location <input id="club_event_location" value="Library 201"></label>
              <label>Capacity <input type="number" id="club_event_capacity" value="10"></label>
              <label>Price (cents) <input type="number" id="club_event_price" value="0"></label>
              <label>Category <input id="club_event_category" value="community"></label>
            </div>
            <div class="button-row aligned">
              <button onclick="createClubEvent()">Create Event</button>
            </div>
          </div>

          <div class="panel leader-card">
            <p class="eyebrow">Pending Members</p>
            <h4>Approve Requests</h4>
            <p class="hint">Review pending join requests for this club.</p>
            <div class="form-grid">
              <label>Approve member email <input id="approve_email" placeholder="student@example.edu"></label>
            </div>
            <div class="button-row aligned">
              <button onclick="approveMember()">Approve</button>
            </div>
            <ul id="pending_members_list" class="stacked-list slim-list"><li class="hint">Load a club to view pending members.</li></ul>
          </div>

          <div class="panel leader-card">
            <p class="eyebrow">Post Announcement</p>
            <h4>Share Updates</h4>
            <p class="hint">Let members know about schedule changes or club news.</p>
            <div class="form-grid">
              <label>Title <input id="ann_title"></label>
              <label>Body <textarea id="ann_body"></textarea></label>
            </div>
            <div class="button-row aligned">
              <button onclick="postAnnouncement()">Post Announcement</button>
            </div>
            <ul id="leader_announcements_list" class="stacked-list slim-list"><li class="hint">Announcements will appear here.</li></ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section data-section-group="mystuff" class="content-section">
    <div class="section-header">
      <p class="eyebrow">My Stuff</p>
      <div>
        <h2>Your Hub</h2>
        <p>Quickly jump to your registered events and club memberships.</p>
      </div>
    </div>
    <div class="row card-grid">
      <div class="panel">
        <div class="section-header compact">
          <div>
            <h3>My Events</h3>
            <p class="hint">See everything you have signed up for.</p>
          </div>
          <button onclick="loadMyEvents()">Load My Events</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Title</th><th>When</th><th>Location</th><th>Category</th></tr>
            </thead>
            <tbody id="my_events_tbody"><tr><td colspan="4">Click the button above to load your registrations.</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="panel">
        <div class="section-header compact">
          <div>
            <h3>My Clubs</h3>
            <p class="hint">Clubs where you are already approved.</p>
          </div>
          <button onclick="loadMyClubs()">Load My Clubs</button>
        </div>
        <ul id="my_club_list" class="card-list"><li>Use the login above, then click the button to load.</li></ul>
      </div>
    </div>
  </section>

  <section class="admin-only content-section" data-section-group="admin">
    <div class="section-header">
      <p class="eyebrow">Admin</p>
      <div>
        <h2>Admin Dashboard</h2>
        <p id="admin_status" class="status" aria-live="polite"></p>
        <p>Approve clubs, monitor flags, and keep the platform tidy.</p>
      </div>
    </div>
    <div class="admin-grid">
      <div class="panel admin-panel">
        <div class="section-header compact">
          <div>
            <h3>Pending Clubs</h3>
            <p class="hint">Review and approve new submissions.</p>
          </div>
          <button onclick="loadPendingClubs()">Load Pending</button>
        </div>
        <div class="table-wrapper">
          <table class="admin-table">
            <thead>
              <tr><th>Club</th><th>Description</th><th>Requester</th><th>Action</th></tr>
            </thead>
            <tbody id="pending_club_tbody">
              <tr><td colspan="4" class="empty-state">Load pending clubs to review submissions.</td></tr>
            </tbody>
          </table>
        </div>
        <p id="pending_club_status" class="status" aria-live="polite"></p>
      </div>
      <div class="panel admin-panel">
        <div class="section-header compact">
          <div>
            <h3>Flagged Content</h3>
            <p class="hint">Resolve reports from across the app.</p>
          </div>
          <button onclick="loadFlags()">Load Flags</button>
        </div>
        <div class="table-wrapper">
          <table class="admin-table">
            <thead>
              <tr><th>Type</th><th>Item</th><th>Reason</th><th>Reporter</th><th>Created</th><th>Action</th></tr>
            </thead>
            <tbody id="flagged_tbody">
              <tr><td colspan="6" class="empty-state">Load flagged content to review reports.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  </div>

<script>
  const API = "http://localhost:8000/api";
  let loadedClubId = null;
  let myRegistrations = new Map();
  let myEvents = [];
  let clubMemberships = new Map();
  let clubRoles = new Map();
  let allClubs = [];
  let myClubs = [];
  let personaName = "";
  let personaEmail = "";
  let personaRole = "";

  function setStatus(id, message, type = "info"){
    const el = document.getElementById(id);
    if(!el){ return; }
    el.textContent = message;
    el.className = `status ${type}`;
  }

  function clearStatus(id){
    setStatus(id, "");
  }

  async function readJson(res){
    try {
      return await res.json();
    } catch (err){
      return null;
    }
  }

  function buildErrorMessage(res, body){
    const detail = body?.detail || body?.error || body?.message;
    return detail ? `${detail} (status ${res.status})` : `Status ${res.status}`;
  }

  function isoPlusDays(days){
    const dt = new Date(Date.now() + days * 86400000);
    dt.setSeconds(0,0);
    return dt.toISOString();
  }

  function formatPrice(cents){
    if(cents === null || cents === undefined){ return "—"; }
    if(Number(cents) === 0){ return "Free"; }
    return `$${(Number(cents) / 100).toFixed(2)}`;
  }

  document.getElementById("event_starts").value = isoPlusDays(2);
  document.getElementById("club_event_starts").value = isoPlusDays(5);

  function updateUserSummary(){
    const summary = document.getElementById("user_summary");
    if(!personaEmail){
      summary.textContent = "";
      return;
    }
    const displayRole = personaRole === "leader" ? "Club Leader" : personaRole.charAt(0).toUpperCase() + personaRole.slice(1);
    const displayName = personaName ? `${personaName} • ` : "";
    summary.textContent = `${displayName}${personaEmail} (${displayRole})`;
  }

  function handleLogin(){
    const name = document.getElementById("login_name").value.trim();
    const email = document.getElementById("login_email").value.trim();
    const role = document.getElementById("login_role").value;

    if(!name || !email){
      setStatus("login_status", "Name and email are required to continue.", "error");
      return;
    }

    personaName = name;
    personaEmail = email;
    personaRole = role;
    clearStatus("login_status");
    startSession();
  }

  function switchUser(event){
    event?.preventDefault();
    personaName = "";
    personaEmail = "";
    personaRole = "";
    myRegistrations = new Map();
    myEvents = [];
    clubMemberships = new Map();
    clubRoles = new Map();
    myClubs = [];
    resetAppContent();
    document.getElementById("login_name").value = "";
    document.getElementById("login_email").value = "";
    document.getElementById("login_role").value = "student";
    document.getElementById("login_section").classList.remove("hidden");
    document.getElementById("app_shell").classList.add("hidden");
    document.getElementById("top_bar").classList.add("hidden");
    updateRoleVisibility();
    updateUserSummary();
  }

  function startSession(){
    document.getElementById("login_section").classList.add("hidden");
    document.getElementById("app_shell").classList.remove("hidden");
    document.getElementById("top_bar").classList.remove("hidden");
    updateRoleVisibility();
    updateUserSummary();
    showNavSection("events");
    loadEvents();
    loadTrending();
    loadClubs();
    loadMyClubs();
    loadClubDetail();
    if(personaRole === "admin"){
      loadPendingClubs();
      loadFlags();
    }
  }

  function resetAppContent(){
    clearStatus("events_status");
    clearStatus("clubs_status");
    clearStatus("admin_status");
    clearStatus("pending_club_status");
    document.getElementById("events_list").innerHTML = "";
    document.getElementById("trending_list").innerHTML = "";
    document.getElementById("club_list").innerHTML = "";
    document.getElementById("club_detail").innerHTML = "";
    document.getElementById("pending_club_tbody").innerHTML = '<tr><td colspan="4" class="empty-state">Load pending clubs to review submissions.</td></tr>';
    document.getElementById("flagged_tbody").innerHTML = '<tr><td colspan="6" class="empty-state">Load flagged content to review reports.</td></tr>';
    document.getElementById("my_events_tbody").innerHTML = '<tr><td colspan="4">Use the login form to load your registrations.</td></tr>';
    document.getElementById("my_club_list").innerHTML = '<li>Use the login form to load your clubs.</li>';
  }

  function buildHeaders(json=true){
    const headers = {
      "X-User-Email": personaEmail,
      "X-User-Role": personaRole
    };
    if(json){ headers["Content-Type"] = "application/json"; }
    return headers;
  }

  function currentPersona(){
    return {
      email: personaEmail,
      role: personaRole
    };
  }

  function canManageEvent(event){
    const persona = currentPersona();
    if(persona.role === "admin"){ return true; }
    if(!event.club_id){ return false; }
    const membershipRole = clubRoles.get(event.club_id);
    return persona.role === "leader" && membershipRole === "leader";
  }

  async function fetchMyRegistrations(renderList=false){
    try {
      const res = await fetch(`${API}/registrations/mine`, { headers: buildHeaders(false) });
      if(!res.ok){
        myRegistrations = new Map();
        myEvents = [];
        if(renderList){ renderMyEvents(); }
        return;
      }
      const data = await res.json();
      myRegistrations = new Map(data.map(r => [r.event.id, r.id]));
      myEvents = data.map(r => r.event);
      if(renderList){ renderMyEvents(); }
    } catch (err){
      console.error("Failed to load registrations", err);
      myRegistrations = new Map();
      myEvents = [];
      if(renderList){ renderMyEvents(); }
    }
  }

  function focusEvent(eventId){
    const row = document.getElementById(`event-row-${eventId}`);
    if(row){
      row.classList.add("highlight");
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      setTimeout(() => row.classList.remove("highlight"), 1600);
    } else {
      setStatus("events_status", "Event not in the current results. Run a search that includes it to jump there.", "error");
    }
  }

  function renderMyEvents(){
    const tbody = document.getElementById("my_events_tbody");
    tbody.innerHTML = "";
    if(myEvents.length === 0){
      tbody.innerHTML = '<tr><td colspan="4">No registrations yet for this user.</td></tr>';
      return;
    }

    myEvents
      .slice()
      .sort((a,b) => new Date(a.starts_at) - new Date(b.starts_at))
      .forEach(ev => {
        const tr = document.createElement("tr");
        tr.classList.add("clickable-row");
        tr.onclick = () => focusEvent(ev.id);
        tr.innerHTML = `<td>${ev.title}</td><td>${new Date(ev.starts_at).toLocaleString()}</td><td>${ev.location}</td><td>${ev.category}</td>`;
        tbody.appendChild(tr);
      });
  }

  async function createEvent(){
    const payload = {
      title: document.getElementById("event_title").value,
      starts_at: document.getElementById("event_starts").value,
      location: document.getElementById("event_location").value,
      capacity: Number(document.getElementById("event_capacity").value),
      price_cents: Number(document.getElementById("event_price").value),
      category: document.getElementById("event_category").value,
      club_id: document.getElementById("event_club").value ? Number(document.getElementById("event_club").value) : null
    };
    const res = await fetch(`${API}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("events_status", "Event created successfully.", "success");
    } else {
      setStatus("events_status", `Create event failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadEvents();
  }

  function resetFilters(){
    document.getElementById("filter_start").value = "";
    document.getElementById("filter_end").value = "";
    document.getElementById("filter_category").value = "";
    document.getElementById("filter_title").value = "";
    document.getElementById("filter_location").value = "";
    document.getElementById("filter_sort").value = "date";
    document.getElementById("filter_free").checked = false;
    loadEvents();
  }

  async function loadEvents(skipRegistrationSync = false){
    clearStatus("events_status");
    const params = new URLSearchParams();
    const start = document.getElementById("filter_start").value;
    const end = document.getElementById("filter_end").value;
    const category = document.getElementById("filter_category").value;
    const title = document.getElementById("filter_title").value;
    const location = document.getElementById("filter_location").value;
    const sort = document.getElementById("filter_sort").value;
    if(start) params.set("start", start);
    if(end) params.set("end", end);
    if(category) params.set("category", category);
    if(title) params.set("title", title);
    if(location) params.set("location", location);
    if(document.getElementById("filter_free").checked) params.set("free_only", true);
    if(sort) params.set("sort", sort);

    if(!skipRegistrationSync){
      await fetchMyRegistrations(false);
    }
    const list = document.getElementById("events_list");
    list.innerHTML = "";

    let res;
    try {
      res = await fetch(`${API}/events?${params.toString()}`);
    } catch (err){
      setStatus("events_status", "Failed to load events. Please try again.", "error");
      list.innerHTML = '<div class="empty-state">Unable to reach the events service.</div>';
      return;
    }

    if(!res.ok){
      const body = await readJson(res);
      setStatus("events_status", `Failed to load events: ${buildErrorMessage(res, body)}`, "error");
      list.innerHTML = '<div class="empty-state">Unable to load events.</div>';
      return;
    }

    const data = await res.json();
    if(data.length === 0){
      list.innerHTML = '<div class="empty-state">No events found. Adjust your filters and try again.</div>';
      return;
    }

    data.forEach(ev => {
      const card = document.createElement("article");
      card.classList.add("event-card");
      card.id = `event-row-${ev.id}`;
      const price = formatPrice(ev.price_cents);
      const popularity = ev.registration_count ?? 0;
      const capacityText = ev.capacity ? `${popularity} registered out of ${ev.capacity} seats` : `${popularity} registered`;

      const header = document.createElement("div");
      header.className = "event-card__header";
      header.innerHTML = `
        <div>
          <p class="event-card__title">${ev.title}</p>
          <p class="event-card__datetime">${new Date(ev.starts_at).toLocaleString()}</p>
        </div>
        <div class="event-card__price">${price}</div>
      `;

      const meta = document.createElement("div");
      meta.className = "event-card__meta";
      meta.innerHTML = `
        <span class="pill">${ev.location}</span>
        <span class="pill pill-muted">${ev.category}</span>
      `;

      const stats = document.createElement("div");
      stats.className = "event-card__stats";
      stats.innerHTML = `
        <span class="seat-info">${capacityText}</span>
      `;

      const actions = document.createElement("div");
      actions.className = "event-card__actions";
      const isRegistered = myRegistrations.has(ev.id);
      const regBtn = document.createElement("button");
      regBtn.classList.add("btn-primary", "register-btn");
      regBtn.textContent = isRegistered ? "Unregister" : "Register";
      regBtn.onclick = () => isRegistered ? unregisterEvent(ev.id) : registerEvent(ev.id);
      const flagBtn = document.createElement("button");
      flagBtn.classList.add("btn-ghost");
      flagBtn.textContent = "Flag";
      flagBtn.onclick = () => flagEvent(ev.id);
      actions.appendChild(regBtn);
      actions.appendChild(flagBtn);
      if(canManageEvent(ev)){
        const deleteBtn = document.createElement("button");
        deleteBtn.classList.add("btn-secondary");
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteEvent(ev.id);
        actions.appendChild(deleteBtn);
      }
      card.appendChild(header);
      card.appendChild(meta);
      card.appendChild(stats);
      card.appendChild(actions);
      list.appendChild(card);
    });
  }

  async function loadTrending(){
    const ul = document.getElementById("trending_list");
    ul.innerHTML = "";
    try {
      const res = await fetch(`${API}/events/trending`);
      if(!res.ok){
        const body = await readJson(res);
        setStatus("events_status", `Failed to load trending: ${buildErrorMessage(res, body)}`, "error");
        ul.innerHTML = '<li>No trending events right now.</li>';
        return;
      }
      const data = await res.json();
      if(data.length === 0){
        ul.innerHTML = '<li>No trending events right now.</li>';
        return;
      }
      data.forEach(ev => {
        const li = document.createElement("li");
        li.textContent = `${ev.title} (${ev.registration_count} regs)`;
        ul.appendChild(li);
      });
    } catch (err){
      setStatus("events_status", "Failed to load trending events.", "error");
      ul.innerHTML = '<li>No trending events right now.</li>';
    }
  }

  async function registerEvent(eventId){
    const res = await fetch(`${API}/registrations`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify({event_id: eventId})
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("events_status", "Registered for event!", "success");
    } else {
      setStatus("events_status", `Register failed: ${buildErrorMessage(res, body)}`, "error");
    }
    await fetchMyRegistrations(true);
    await loadEvents(true);
  }

  async function unregisterEvent(eventId){
    const res = await fetch(`${API}/registrations/${eventId}`, {
      method: "DELETE",
      headers: buildHeaders(false)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("events_status", "You are no longer registered for this event.", "success");
    } else {
      setStatus("events_status", `Unregister failed: ${buildErrorMessage(res, body)}`, "error");
    }
    await fetchMyRegistrations(true);
    await loadEvents(true);
  }

  async function deleteEvent(eventId){
    if(!confirm("Delete this event?")){ return; }
    const res = await fetch(`${API}/events/${eventId}`, {
      method: "DELETE",
      headers: buildHeaders(false)
    });
    const detail = await readJson(res);
    const message = res.ok ? "Event deleted" : `Delete failed: ${buildErrorMessage(res, detail)}`;
    setStatus("events_status", message, res.ok ? "success" : "error");
    await fetchMyRegistrations(true);
    await loadEvents();
    if(loadedClubId){
      await loadClubDetail();
    }
  }

  async function loadMyEvents(){
    await fetchMyRegistrations(true);
  }

  function renderClubs(clubs){
    const ul = document.getElementById("club_list");
    ul.innerHTML = "";
    if(clubs.length === 0){
      ul.innerHTML = '<li class="empty-state">No clubs match your search.</li>';
      return;
    }

    clubs.forEach(club => {
      const li = document.createElement("li");
      li.classList.add("club-card");
      const categoryLabel = club.category ? `<span class="pill pill-muted">${club.category}</span>` : '<span class="pill pill-muted">General</span>';
      const memberCopy = club.member_count === 1 ? "Member" : "Members";
      const eventCopy = club.upcoming_event_count === 1 ? "Upcoming Event" : "Upcoming Events";
      li.innerHTML = `
        <div class="club-card__header">
          <div>
            <h4 class="club-card__title">${club.name}</h4>
            <p class="club-card__description">${club.description}</p>
            <div class="club-card__meta">${categoryLabel}
              <span class="pill pill-muted">${club.member_count} ${memberCopy}</span>
              <span class="pill pill-muted">${club.upcoming_event_count} ${eventCopy}</span>
            </div>
          </div>
        </div>
      `;
      const action = document.createElement("div");
      action.classList.add("club-card__actions");
      const status = clubMemberships.get(club.id);
      const statusCopy = status === "approved" ? "You are a member" : status === "pending" ? "Request pending" : "Not a member";
      const statusText = document.createElement("p");
      statusText.classList.add("hint", "club-card__status");
      statusText.textContent = statusCopy;
      const btn = document.createElement("button");
      btn.classList.add("club-card__cta");
      if(status === "approved"){
        btn.textContent = "Leave";
        btn.onclick = () => leaveClub(club.id);
      } else if(status === "pending"){
        btn.textContent = "Pending";
        btn.disabled = true;
      } else {
        btn.textContent = "Join";
        btn.onclick = () => joinClub(club.id);
      }
      action.appendChild(btn);
      action.appendChild(statusText);
      li.appendChild(action);
      ul.appendChild(li);
    });
  }

  async function loadClubs(){
    try {
      const res = await fetch(`${API}/clubs`, { headers: buildHeaders(false) });
      if(!res.ok){
        const body = await readJson(res);
        setStatus("clubs_status", `Failed to load clubs: ${buildErrorMessage(res, body)}`, "error");
        document.getElementById("club_list").innerHTML = '<li>Unable to load clubs right now.</li>';
        return;
      }
      const data = await res.json();
      allClubs = data;
      clubMemberships = new Map(data.map(club => [club.id, club.membership_status]));
      clubRoles = new Map(data.map(club => [club.id, club.membership_role]));
      filterClubList();
    } catch (err){
      setStatus("clubs_status", "Failed to load clubs.", "error");
      document.getElementById("club_list").innerHTML = '<li>Unable to load clubs right now.</li>';
    }
  }

  function renderMyClubs(){
    const ul = document.getElementById("my_club_list");
    ul.innerHTML = "";
    if(myClubs.length === 0){
      ul.innerHTML = '<li>No approved club memberships for this user yet.</li>';
      return;
    }
    myClubs.forEach(club => {
      const li = document.createElement("li");
      li.textContent = `${club.name} — ${club.description}`;
      ul.appendChild(li);
    });
  }

  async function loadMyClubs(){
    try {
      const res = await fetch(`${API}/clubs/mine`, { headers: buildHeaders(false) });
      if(!res.ok){
        myClubs = [];
        setStatus("clubs_status", "Failed to load your clubs.", "error");
      } else {
        myClubs = await res.json();
        clearStatus("clubs_status");
      }
    } catch (err){
      console.error("Failed to load my clubs", err);
      myClubs = [];
      setStatus("clubs_status", "Failed to load your clubs.", "error");
    }
    renderMyClubs();
  }

  async function createClub(){
    const payload = {
      name: document.getElementById("club_name").value,
      description: document.getElementById("club_desc").value
    };
    const res = await fetch(`${API}/clubs`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("clubs_status", "Club submitted for approval.", "success");
      document.getElementById("club_create_result").textContent = "Your club was submitted and is awaiting review.";
    } else {
      setStatus("clubs_status", `Create club failed: ${buildErrorMessage(res, body)}`, "error");
      document.getElementById("club_create_result").textContent = "Unable to submit club right now.";
    }
    if(personaRole === "admin"){
      loadPendingClubs();
    }
  }

  async function joinClub(id){
    const clubId = id ?? Number(document.getElementById("join_club_id").value);
    if(!clubId){ return; }
    const res = await fetch(`${API}/clubs/${clubId}/join`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    const body = await res.json();
    const joinStatus = document.getElementById("club_join_result");
    if(res.ok){
      setStatus("clubs_status", "Join request sent.", "success");
      joinStatus.textContent = "Your join request was submitted.";
      joinStatus.classList.remove("error");
      joinStatus.classList.add("success");
    } else {
      const message = `Join request failed: ${buildErrorMessage(res, body)}`;
      setStatus("clubs_status", message, "error");
      joinStatus.textContent = message;
      joinStatus.classList.remove("success");
      joinStatus.classList.add("error");
    }
    await loadClubs();
    await loadMyClubs();
  }

  async function leaveClub(id){
    if(!id){ return; }
    const res = await fetch(`${API}/clubs/${id}/leave`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    const body = await res.json();
    const joinStatus = document.getElementById("club_join_result");
    if(res.ok){
      setStatus("clubs_status", "Left club.", "success");
      joinStatus.textContent = "You have left the club.";
      joinStatus.classList.remove("error");
      joinStatus.classList.add("success");
    } else {
      const message = `Leave failed: ${buildErrorMessage(res, body)}`;
      setStatus("clubs_status", message, "error");
      joinStatus.textContent = message;
      joinStatus.classList.remove("success");
      joinStatus.classList.add("error");
    }
    await loadClubs();
    await loadMyClubs();
  }

  function filterClubList(){
    const search = document.getElementById("club_search")?.value.trim().toLowerCase() ?? "";
    const filtered = !search
      ? allClubs
      : allClubs.filter(club =>
          club.name.toLowerCase().includes(search) ||
          club.description.toLowerCase().includes(search)
        );
    renderClubs(filtered);
  }

  async function loadClubDetail(){
    const id = Number(document.getElementById("club_detail_id").value);
    if(!id){
      setStatus("club_detail_status", "Enter a club ID to load.", "error");
      return;
    }
    let res;
    try {
      res = await fetch(`${API}/clubs/${id}`, { headers: buildHeaders(false) });
    } catch (err){
      setStatus("club_detail_status", "Failed to load club details.", "error");
      document.getElementById("club_detail").textContent = "";
      return;
    }
    if(!res.ok){
      const body = await readJson(res);
      setStatus("club_detail_status", `Failed to load club: ${buildErrorMessage(res, body)}`, "error");
      document.getElementById("club_detail").textContent = "";
      return;
    }
    const data = await res.json();
    clearStatus("club_detail_status");
    loadedClubId = id;
    const div = document.getElementById("club_detail");
    const members = data.members.map(m => {
      const roleLabel = m.role.charAt(0).toUpperCase() + m.role.slice(1);
      const statusLabel = m.status.charAt(0).toUpperCase() + m.status.slice(1);
      return `<li class="member-row"><span class="member-email">${m.user_email}</span><span class="badge badge-role">${roleLabel}</span><span class="badge badge-status">${statusLabel}</span></li>`;
    }).join('');
    const announcements = data.announcements.map(a => {
      const date = new Date(a.created_at).toLocaleDateString();
      return `<li class="announcement-row"><span class="announcement-date">${date}</span> <strong>${a.title}</strong> — ${a.body} <button class="btn-ghost" onclick=\"flagAnnouncement(${a.id})\">Flag</button></li>`;
    }).join('');
    const persona = currentPersona();
    const isClubLeader = data.members.some(m => m.user_email === persona.email && m.role === "leader" && m.status === "approved");
    const canManageClubEvents = persona.role === "admin" || isClubLeader;
    const events = data.events
      .map(ev => {
        const deleteBtn = canManageClubEvents ? ` <button class="btn-ghost" onclick="deleteEvent(${ev.id})">Delete</button>` : '';
        return `<li class="event-row"><div><strong>${ev.title}</strong><p class="hint">${new Date(ev.starts_at).toLocaleDateString()}</p></div><div class="event-meta">Cap ${ev.capacity} · ${ev.registration_count} registered</div>${deleteBtn}</li>`;
      })
      .join('');
    const overviewBadges = `
      <div class="club-detail__meta">
        <span class="pill">${data.club.member_count} Members</span>
        <span class="pill pill-muted">${data.club.upcoming_event_count} Upcoming Events</span>
      </div>`;
    div.innerHTML = `
      <div class="club-detail__section">
        <p class="eyebrow">Overview</p>
        <h3>${data.club.name} ${data.club.approved ? '' : '(Pending)'}</h3>
        <p class="club-detail__description">${data.club.description}</p>
        ${overviewBadges}
      </div>
      <div class="club-detail__grid">
        <div class="club-detail__section">
          <h4>Upcoming Events</h4>
          <ul class="stacked-list">${events || '<li class="hint">No upcoming events</li>'}</ul>
        </div>
        <div class="club-detail__section">
          <h4>Members</h4>
          <ul class="stacked-list">${members || '<li class="hint">No members listed</li>'}</ul>
        </div>
        <div class="club-detail__section">
          <h4>Announcements</h4>
          <ul class="stacked-list">${announcements || '<li class="hint">No announcements</li>'}</ul>
        </div>
      </div>
    `;

    const pendingMembers = data.members.filter(m => m.status === "pending");
    const pendingList = document.getElementById("pending_members_list");
    if(pendingList){
      pendingList.innerHTML = pendingMembers.length
        ? pendingMembers.map(m => {
            const roleLabel = m.role.charAt(0).toUpperCase() + m.role.slice(1);
            return `<li class="member-row"><span class="member-email">${m.user_email}</span><span class="badge badge-role">${roleLabel}</span><button class="btn-secondary" onclick=\"approveMember('${m.user_email}')\">Approve</button></li>`;
          }).join('')
        : '<li class="hint">No pending requests.</li>';
    }

    const announcementList = document.getElementById("leader_announcements_list");
    if(announcementList){
      announcementList.innerHTML = data.announcements.length
        ? data.announcements.map(a => {
            const date = new Date(a.created_at).toLocaleDateString();
            return `<li class="announcement-row"><span class="announcement-date">${date}</span><strong>${a.title}</strong><span>${a.body}</span></li>`;
          }).join('')
        : '<li class="hint">No announcements yet.</li>';
    }

    const leaderDashboard = document.getElementById("leader_dashboard");
    if(leaderDashboard){
      const shouldShowLeaderTools = persona.role === "admin" || isClubLeader;
      leaderDashboard.classList.toggle("hidden", !shouldShowLeaderTools);
    }
  }

  async function approveMember(emailOverride){
    if(!loadedClubId){ setStatus('club_detail_status', 'Load a club first.', 'error'); return; }
    const email = emailOverride ?? document.getElementById("approve_email").value;
    const res = await fetch(`${API}/clubs/${loadedClubId}/members/${encodeURIComponent(email)}/approve`, {
      method: "POST",
      headers: buildHeaders(true)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("club_detail_status", "Member approved.", "success");
    } else {
      setStatus("club_detail_status", `Approve member failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadClubDetail();
  }

  async function postAnnouncement(){
    if(!loadedClubId){ setStatus('club_detail_status', 'Load a club first.', 'error'); return; }
    const payload = {
      title: document.getElementById("ann_title").value,
      body: document.getElementById("ann_body").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/announcements`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("club_detail_status", "Announcement posted.", "success");
    } else {
      setStatus("club_detail_status", `Announcement failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadClubDetail();
  }

  async function createClubEvent(){
    if(!loadedClubId){ setStatus('club_detail_status', 'Load a club first.', 'error'); return; }
    const payload = {
      title: document.getElementById("club_event_title").value,
      starts_at: document.getElementById("club_event_starts").value,
      location: document.getElementById("club_event_location").value,
      capacity: Number(document.getElementById("club_event_capacity").value),
      price_cents: Number(document.getElementById("club_event_price").value),
      category: document.getElementById("club_event_category").value
    };
    const res = await fetch(`${API}/clubs/${loadedClubId}/events`, {
      method: "POST",
      headers: buildHeaders(true),
      body: JSON.stringify(payload)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("club_detail_status", "Club event created.", "success");
    } else {
      setStatus("club_detail_status", `Club event failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadClubDetail();
  }

  async function flagEvent(id){
    const reason = prompt("Why are you flagging this event?");
    if(!reason){ return; }
    try {
      const res = await fetch(`${API}/flags`, {
        method: "POST",
        headers: buildHeaders(true),
        body: JSON.stringify({ item_type: "event", item_id: id, reason })
      });
      const body = await readJson(res);
      if(res.ok){
        setStatus("events_status", "Flag submitted.", "success");
      } else {
        setStatus("events_status", `Flag failed: ${buildErrorMessage(res, body)}`, "error");
      }
    } catch (err){
      setStatus("events_status", "Flag failed.", "error");
    }
  }

  async function flagAnnouncement(id){
    const reason = prompt("Why are you flagging this announcement?");
    if(!reason){ return; }
    try {
      const res = await fetch(`${API}/flags`, {
        method: "POST",
        headers: buildHeaders(true),
        body: JSON.stringify({ item_type: "announcement", item_id: id, reason })
      });
      const body = await readJson(res);
      if(res.ok){
        setStatus("club_detail_status", "Flag submitted.", "success");
      } else {
        setStatus("club_detail_status", `Flag failed: ${buildErrorMessage(res, body)}`, "error");
      }
    } catch (err){
      setStatus("club_detail_status", "Flag failed.", "error");
    }
  }

  async function loadFlags(){
    if(personaRole !== "admin"){
      setStatus("admin_status", "Admin role required.", "error");
      return;
    }
    const tbody = document.getElementById("flagged_tbody");
    tbody.innerHTML = "";
    try {
      const res = await fetch(`${API}/admin/flags`, { headers: buildHeaders(false) });
      if(res.status === 403){
        setStatus("admin_status", "Admin role required.", "error");
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Admin role required.</td></tr>';
        return;
      }
      if(!res.ok){
        const body = await readJson(res);
        setStatus("admin_status", `Failed to load flags: ${buildErrorMessage(res, body)}`, "error");
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No flagged items found.</td></tr>';
        return;
      }
      const data = await res.json();
      if(data.length === 0){
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No flagged items found.</td></tr>';
        clearStatus("admin_status");
        return;
      }
      clearStatus("admin_status");
      data.forEach(flag => {
        const label = flag.item_type === "event" ? `Event #${flag.item_id}` : `Announcement #${flag.item_id}`;
        const reason = flag.reason || "No reason provided.";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="pill-cell"><span class="pill pill-muted">${flag.item_type === "event" ? "Event" : "Announcement"}</span></td>
          <td>${label}</td>
          <td>${reason}</td>
          <td>${flag.user_email}</td>
          <td>${new Date(flag.created_at).toLocaleString()}</td>
          <td><button class="btn-secondary" onclick="resolveFlag(${flag.id})">Resolve</button></td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err){
      setStatus("admin_status", "Failed to load flags.", "error");
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No flagged items found.</td></tr>';
    }
  }

  async function resolveFlag(id){
    if(personaRole !== "admin"){
      setStatus("admin_status", "Admin role required.", "error");
      return;
    }
    const res = await fetch(`${API}/admin/flags/${id}/resolve`, { method: "POST", headers: buildHeaders(false) });
    if(res.ok){
      setStatus("admin_status", "Flag resolved successfully.", "success");
    } else {
      const body = await readJson(res);
      setStatus("admin_status", `Resolve failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadFlags();
  }

  async function loadPendingClubs(){
    if(personaRole !== "admin"){
      setStatus("pending_club_status", "Admin role required.", "error");
      return;
    }
    const tbody = document.getElementById("pending_club_tbody");
    tbody.innerHTML = "";
    try {
      const res = await fetch(`${API}/admin/clubs/pending`, { headers: buildHeaders(false) });
      if(res.status === 403){
        setStatus("pending_club_status", "Admin role required.", "error");
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Admin role required.</td></tr>';
        return;
      }
      if(!res.ok){
        const body = await readJson(res);
        setStatus("pending_club_status", `Failed to load pending clubs: ${buildErrorMessage(res, body)}`, "error");
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No pending clubs.</td></tr>';
        return;
      }
      const data = await res.json();
      if(data.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No pending clubs.</td></tr>';
        clearStatus("pending_club_status");
        return;
      }
      clearStatus("pending_club_status");
      data.forEach(club => {
        const description = club.description || "No description provided.";
        const requester = club.created_by_email || "Unknown";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div class="table-title">${club.name}</div><div class="muted">ID ${club.id}</div></td>
          <td>${description}</td>
          <td>${requester}</td>
          <td><button class="btn-secondary" onclick="approveClub(${club.id})">Approve</button></td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err){
      setStatus("pending_club_status", "Failed to load pending clubs.", "error");
      tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No pending clubs.</td></tr>';
    }
  }

  async function approveClub(idOverride){
    if(personaRole !== "admin"){
      setStatus("pending_club_status", "Admin role required.", "error");
      return;
    }
    const id = typeof idOverride === "number" ? idOverride : null;
    if(!id){
      setStatus("pending_club_status", "Choose a club to approve.", "error");
      return;
    }
    const res = await fetch(`${API}/admin/clubs/${id}/approve`, {
      method: "POST",
      headers: buildHeaders(false)
    });
    const body = await readJson(res);
    if(res.ok){
      setStatus("pending_club_status", "Club approved successfully.", "success");
    } else {
      setStatus("pending_club_status", `Approve failed: ${buildErrorMessage(res, body)}`, "error");
    }
    loadClubs();
    loadPendingClubs();
  }

  // initial data
  const sectionGroups = ["events", "clubs", "mystuff", "admin"];

  function showNavSection(target){
    if(target === "admin" && personaRole !== "admin"){
      target = "events";
    }
    sectionGroups.forEach(group => {
      document.querySelectorAll(`[data-section-group="${group}"]`).forEach(section => {
        section.classList.toggle("hidden", group !== target);
      });
    });

    document.querySelectorAll(".nav-button").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.target === target);
    });
  }

  function updateRoleVisibility(){
    const role = personaRole;
    document.querySelectorAll(".admin-only").forEach(el => {
      const hidden = role !== "admin";
      el.classList.toggle("hidden", hidden);
      el.setAttribute("aria-hidden", hidden);
    });
    document.querySelectorAll(".leader-only").forEach(el => {
      const hidden = role !== "leader" && role !== "admin";
      el.classList.toggle("hidden", hidden);
      el.setAttribute("aria-hidden", hidden);
    });

    const activeNav = document.querySelector(".nav-button.active")?.dataset.target ?? "events";
    if(role !== "admin" && activeNav === "admin"){
      showNavSection("events");
    }
  }

  resetAppContent();
  updateRoleVisibility();
  showNavSection("events");
</script>
</body>
</html>
